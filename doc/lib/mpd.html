<!DOCTYPE html><html lang="en"><head><title>lib/mpd</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="lib/mpd"><meta name="groc-project-path" content="lib/mpd.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">lib/mpd.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-pi">"use strict"</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="initialization">Initialization</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> MPD_HOST = process.env.MPD_HOST || <span class="hljs-string">'localhost'</span>;
<span class="hljs-keyword">var</span> MPD_PORT = process.env.MPD_PORT || <span class="hljs-number">6600</span>;

<span class="hljs-keyword">var</span> net = <span class="hljs-built_in">require</span>(<span class="hljs-string">'net'</span>);
<span class="hljs-keyword">var</span> EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>).EventEmitter;

<span class="hljs-keyword">var</span> client = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">var</span> state = {};
<span class="hljs-keyword">var</span> events = <span class="hljs-keyword">new</span> EventEmitter();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="public-api">Public API</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="event-handlers">Event handlers</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">exports.on = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">on</span><span class="hljs-params">()</span> {</span>
    events.on.apply(events, <span class="hljs-built_in">arguments</span>);
};

exports.once = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">once</span><span class="hljs-params">()</span> {</span>
    events.once.apply(events, <span class="hljs-built_in">arguments</span>);
};

exports.removeListener = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">removeListener</span><span class="hljs-params">()</span> {</span>
    events.removeListener.apply(events, <span class="hljs-built_in">arguments</span>);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="connection">Connection</h2></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Connects to MPD.</p>
<p>Parameters:</p>
<ul>
<li><p><strong>port is optional and must be a Number.</strong></p>
</li>
<li><p><strong>host is optional and must be a String.</strong></p>
</li>
</ul></div></div><div class="code"><div class="wrapper">exports.connect = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">connect</span><span class="hljs-params">(port, host)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt; <span class="hljs-number">1</span>) port = MPD_PORT;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt; <span class="hljs-number">2</span>) host = MPD_HOST;

    <span class="hljs-keyword">if</span> (client === <span class="hljs-literal">null</span>) {
        state = {}; <span class="hljs-comment">// reset state</span>
        client = net.connect({
            <span class="hljs-string">'port'</span>: port,
            <span class="hljs-string">'host'</span>: host,
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onConnect</span><span class="hljs-params">()</span> {</span>
            updateState();
        });

        events.once(<span class="hljs-string">'updated'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onceUpdated</span><span class="hljs-params">()</span> {</span>
            events.emit(<span class="hljs-string">'connection:ready'</span>);
        });

        client.on(<span class="hljs-string">'data'</span>, dataHandler);
        events.on(<span class="hljs-string">'changed'</span>, changedHandler);

        client.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onEnd</span><span class="hljs-params">()</span> {</span>
            client = <span class="hljs-literal">null</span>;
            events.emit(<span class="hljs-string">'connection:closed'</span>);
        });
    }
    <span class="hljs-keyword">else</span> {
        events.emit(<span class="hljs-string">'connection:error'</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Connection already open.'</span>));
    }
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Closes the connection to MPD. </p></div></div><div class="code"><div class="wrapper">exports.end = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">end</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (client !== <span class="hljs-literal">null</span>) {
        client.end();
    }
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Alias for end. </p></div></div><div class="code"><div class="wrapper">exports.close = exports.end;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="commands">Commands</h2>
<p>The commands that follow are commands that are publicly available.
That is, these commands are safe to be called by a client.</p></div></div><div class="code"><div class="wrapper">exports.commands = {};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="querying-mpd39s-status">Querying MPD&#39;s status</h3></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Reports the current status of the player and the volume level. </p></div></div><div class="code"><div class="wrapper">exports.commands.status = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">status</span><span class="hljs-params">()</span> {</span>
    write(<span class="hljs-string">'status'</span>);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Displayes statistics. </p></div></div><div class="code"><div class="wrapper">exports.commands.stats = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stats</span><span class="hljs-params">()</span> {</span>
    write(<span class="hljs-string">'stats'</span>);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="playback-options">Playback options</h3></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Toggles <code>consume</code>. </p></div></div><div class="code"><div class="wrapper">exports.commands.consume = toggleFactory(<span class="hljs-string">'consume'</span>);</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Sets crossfade.</p>
<p>Parameters:</p>
<ul>
<li><strong>seconds must be a Number.</strong></li>
</ul></div></div><div class="code"><div class="wrapper">exports.commands.crossfade = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">crossfade</span><span class="hljs-params">(seconds)</span> {</span>
    write(<span class="hljs-string">'crossfade'</span>, seconds);
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>TODO: mixrampdb </p>
<p>TODO: mixrampdelay </p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Toggles <code>random</code>.</p></div></div><div class="code"><div class="wrapper">exports.commands.random = toggleFactory(<span class="hljs-string">'random'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Toggles <code>repeat</code>. </p></div></div><div class="code"><div class="wrapper">exports.commands.repeat = toggleFactory(<span class="hljs-string">'repeat'</span>);</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Sets the volume.</p>
<p>Parameters:</p>
<ul>
<li><strong>vol must be a Number.</strong><br/>(A level between 0-100.)</li>
</ul></div></div><div class="code"><div class="wrapper">exports.commands.volume = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">volume</span><span class="hljs-params">(vol)</span> {</span>
    write(<span class="hljs-string">'setvol'</span>, vol);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Toggles <code>single</code>. </p></div></div><div class="code"><div class="wrapper">exports.commands.single = toggleFactory(<span class="hljs-string">'single'</span>);</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Sets the replay gain mode. One of <code>off</code>, <code>track</code>, <code>album</code>, <code>auto</code>.</p>
<p>Parameters:</p>
<ul>
<li><strong>mode must be a String.</strong></li>
</ul></div></div><div class="code"><div class="wrapper">exports.commands.replayGainMode = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">replayGainMode</span><span class="hljs-params">(mode)</span> {</span>
    write(<span class="hljs-string">'replay_gain_mode'</span>, mode);
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>TODO: replay_gain_status </p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="controlling-playback">Controlling playback</h3></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Plays the next song in the playlist. </p></div></div><div class="code"><div class="wrapper">exports.commands.next = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span><span class="hljs-params">()</span> {</span>
    write(<span class="hljs-string">'next'</span>);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Toggles playback. </p></div></div><div class="code"><div class="wrapper">exports.commands.pause = toggleFactory(<span class="hljs-string">'state'</span>, <span class="hljs-literal">true</span>, <span class="hljs-string">'pause'</span>, <span class="hljs-string">'pause'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Alias for pause. </p></div></div><div class="code"><div class="wrapper">exports.commands.toggle = exports.commands.pause;</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Begins paying the playlist at song number <code>songpos</code>.</p>
<p>Parameters:</p>
<ul>
<li><strong>songpos is optional and must be a Number.</strong></li>
</ul></div></div><div class="code"><div class="wrapper">exports.commands.play = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">play</span><span class="hljs-params">(songpos)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">0</span>) {
        write(<span class="hljs-string">'play'</span>);
    }
    <span class="hljs-keyword">else</span> {
        write(<span class="hljs-string">'play'</span>, songpos);
    }
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>TODO: playid [SONGID] </p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Plays the previous song in the playlist. </p></div></div><div class="code"><div class="wrapper">exports.commands.previous = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">previous</span><span class="hljs-params">()</span> {</span>
    write(<span class="hljs-string">'previous'</span>);
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Seeks to the position <code>time</code> of entry <code>songpos</code>.</p>
<p>Parameters:</p>
<ul>
<li><p><strong>songpos must be a Number.</strong></p>
</li>
<li><p><strong>time must be a Number.</strong><br/>(In seconds, fractions allowed.)</p>
</li>
</ul></div></div><div class="code"><div class="wrapper">exports.commands.seek = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">seek</span><span class="hljs-params">(songpos, time)</span> {</span>
    write(<span class="hljs-string">'seek'</span>, songpos, time);
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>TODO: seekid {SONGID} {TIME} </p></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Seeks to position <code>time</code> within the current song.</p>
<p>If <code>time</code> is prefixed by <code>+</code> or <code>-</code>, then the time is relative to the
current playing position.</p>
<p>Parameters:</p>
<ul>
<li><strong>time can be a Number or a String.</strong><br/>(In seconds, fractions allowed.)</li>
</ul></div></div><div class="code"><div class="wrapper">exports.commands.seekcur = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">seekcur</span><span class="hljs-params">(time)</span> {</span>
    write(<span class="hljs-string">'seekcur'</span>, time);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Stops playing. </p></div></div><div class="code"><div class="wrapper">exports.commands.stop = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span> {</span>
    write(<span class="hljs-string">'stop'</span>);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="private-methods">Private methods</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Initializes the internal state.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateState</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (client != <span class="hljs-literal">null</span>) {
        client.write([
            <span class="hljs-string">'noidle'</span>,
            <span class="hljs-string">'command_list_begin'</span>,
            <span class="hljs-string">'currentsong'</span>,
            <span class="hljs-string">'status'</span>,
            <span class="hljs-string">'stats'</span>,
            <span class="hljs-string">'command_list_end'</span>,
            <span class="hljs-string">'idle'</span>,
        ].join(<span class="hljs-string">'\n'</span>) + <span class="hljs-string">'\n'</span>);
    }
}</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Handles the incoming data from the client.</p>
<p>Parameters:</p>
<ul>
<li><strong>data must be a Buffer.</strong></li>
</ul></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dataHandler</span><span class="hljs-params">(data)</span> {</span>
    <span class="hljs-keyword">var</span> updated = <span class="hljs-literal">false</span>,
        i, key, value;

    <span class="hljs-comment">//console.info('received', {data:data.toString()});</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>TODO: Do we need toString?</p></div></div><div class="code"><div class="wrapper">    data.toString().split(<span class="hljs-string">'\n'</span>).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(line)</span> {</span>
        <span class="hljs-keyword">if</span> (line === <span class="hljs-string">'OK'</span> || line === <span class="hljs-string">''</span> || line === <span class="hljs-string">'list_OK'</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>For now we ignore these lines.</p></div></div><div class="code"><div class="wrapper">        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (line.match(<span class="hljs-regexp">/^changed: /</span>)) {
            value = line.substring(<span class="hljs-string">'changed: '</span>.length);
            events.emit(<span class="hljs-string">'changed'</span>, value);
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (line.match(<span class="hljs-regexp">/: /</span>)) {
            i = line.indexOf(<span class="hljs-string">': '</span>);
            key = line.substring(<span class="hljs-number">0</span>, i);
            value = line.substring(i + <span class="hljs-number">2</span>);

            state[key] = value;
            updated = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (line.match(<span class="hljs-regexp">/^OK MPD/</span>)) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>mpd version</p></div></div><div class="code"><div class="wrapper">        }
        <span class="hljs-keyword">else</span> {
            console.error(<span class="hljs-string">'unknown line,'</span>, {line:line});
        }
    });

    <span class="hljs-keyword">if</span> (updated) {
        events.emit(<span class="hljs-string">'updated'</span>, state);
    }
}</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Handles <code>changed</code> events.</p>
<p>TODO: </p>
<p>Parameters:</p>
<ul>
<li><strong>what must be a String.</strong></li>
</ul></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">changedHandler</span><span class="hljs-params">(what)</span> {</span>
    updateState();
}</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Writes sanitized data to the MPD connection.</p>
<p>First the command <code>noidle</code> is sent.</p>
<p>Newlines are replaced by spaces and all arguments to this function
are joined into a single string (space separated).</p>
<p>Finally the command <code>idle</code> is sent.</p>
<p>Parameters:</p>
<pre><code>* **...data must be a String.**</code></pre></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span><span class="hljs-params">(data)</span> {</span>
    <span class="hljs-keyword">var</span> i;
    <span class="hljs-keyword">if</span> (client !== <span class="hljs-literal">null</span>) {
        client.write(<span class="hljs-string">'noidle\n'</span>);
        data = <span class="hljs-string">''</span>;
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">arguments</span>.length; i++) {
            <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) {
                data += <span class="hljs-string">' '</span>;
            }
            data += <span class="hljs-built_in">arguments</span>[i].replace(<span class="hljs-string">'\n'</span>, <span class="hljs-string">' '</span>);
        }
        client.write(data + <span class="hljs-string">'\n'</span>);
        client.write(<span class="hljs-string">'idle\n'</span>);
    }
}</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Creates a toggle method.</p>
<p>Parameters:</p>
<ul>
<li><p><strong>key must be a String.</strong><br/>(The name of the key within the state.)</p>
</li>
<li><p><strong>invert is optional, must be a Boolean, and has a default value of false.</strong><br/>(Invert the logic for computing the current state.)</p>
</li>
<li><p><strong>command is optional and must be a String.</strong><br/>(The command to send to MPD. Defaults to <code>key</code>.)</p>
</li>
<li><p><strong>trueVal is optional, can be of any type, and has a default value of 1.</strong><br/>(The value to consider as <code>true</code>.)</p>
</li>
</ul>
<p><strong>Returns a Function</strong></p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toggleFactory</span><span class="hljs-params">(key, invert, command, trueVal)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt; <span class="hljs-number">3</span>) {
        command = key;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt; <span class="hljs-number">4</span>) {
        trueVal = <span class="hljs-string">'1'</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toggle</span><span class="hljs-params">(value)</span> {</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">0</span>) {
            value = state[key] === trueVal;
            <span class="hljs-keyword">if</span> (invert) {
                value = !value;
            }
        }
        write(command, value ? <span class="hljs-string">'1'</span> : <span class="hljs-string">'0'</span>);
    };
}</div></div></div></div></body></html>